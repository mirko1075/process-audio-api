openapi: 3.1.0
info:
  title: AI Medical Transcription Backend
  description: |
    A production-ready Flask backend for transcribing, translating and analysing
    medical conversations. The service integrates with Deepgram Nova-2 for
    transcription, OpenAI GPT models for translation, and optional AssemblyAI /
    Google Cloud services.
  version: 1.0.0
  contact:
    name: API Support
    email: support@example.com

servers:
  - url: http://localhost:5000
    description: Development server
  - url: https://your-production-url.com
    description: Production server

security:
  - ApiKeyAuth: []

paths:
  /:
    get:
      summary: Root endpoint
      description: Welcome message and API information
      tags:
        - Health
      security: []
      responses:
        '200':
          description: Welcome message
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "AI Medical Transcription Backend"

  /health:
    get:
      summary: Health check endpoint
      description: Return a simple health payload used by orchestrators
      tags:
        - Health
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: "ok"

  /transcriptions/deepgram:
    post:
      summary: Transcribe audio using Deepgram Nova-2
      description: Upload an audio file to transcribe using Deepgram's Nova-2 model
      tags:
        - Transcription
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - audio
              properties:
                audio:
                  type: string
                  format: binary
                  description: Audio file to transcribe
                language:
                  type: string
                  default: "en"
                  description: Language code for transcription
                  example: "en"
                model:
                  type: string
                  description: Deepgram model to use
                  example: "nova-2"
      responses:
        '200':
          description: Transcription successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TranscriptionResponse'
        '400':
          description: Bad request - no audio file uploaded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          description: Transcription failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /transcriptions/whisper:
    post:
      summary: Transcribe audio using OpenAI Whisper with automatic chunking
      description: |
        Upload an audio file to transcribe using OpenAI's Whisper model. 
        Large files (>24MB) are automatically split into 10-minute chunks and processed sequentially.
        The service handles files of any size without manual intervention.
      tags:
        - Transcription
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - audio
              properties:
                audio:
                  type: string
                  format: binary
                  description: Audio file to transcribe
                language:
                  type: string
                  description: Language code for transcription (optional)
                  example: "en"
      responses:
        '200':
          description: Transcription successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TranscriptionResponse'
        '400':
          description: Bad request - no audio file uploaded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          description: Transcription failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /transcriptions/assemblyai:
    post:
      summary: Transcribe audio using AssemblyAI
      description: Upload an audio file to transcribe using AssemblyAI service
      tags:
        - Transcription
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - audio
              properties:
                audio:
                  type: string
                  format: binary
                  description: Audio file to transcribe
                language:
                  type: string
                  default: "en"
                  description: Language code for transcription
                  example: "en"
      responses:
        '200':
          description: Transcription successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TranscriptionResponse'
        '400':
          description: Bad request - no audio file uploaded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          description: Transcription failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /transcriptions/transcribe-and-translate:
    post:
      summary: Combined transcription and translation
      description: Transcribe an audio file and optionally translate the result in one call
      tags:
        - Transcription
        - Translation
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - audio
              properties:
                audio:
                  type: string
                  format: binary
                  description: Audio file to transcribe
                translate:
                  type: string
                  enum: ["true", "false"]
                  default: "false"
                  description: Whether to translate the transcription
                transcript_model:
                  type: string
                  enum: ["deepgram", "whisper", "assemblyai"]
                  default: "deepgram"
                  description: Transcription service to use
                translation_model:
                  type: string
                  enum: ["google", "openai"]
                  default: "google"
                  description: Translation service to use (if translate=true)
                language:
                  type: string
                  default: "en"
                  description: Source language code
                target_language:
                  type: string
                  default: "en"
                  description: Target language code for translation
      responses:
        '200':
          description: Transcription and optional translation successful
          content:
            application/json:
              schema:
                type: object
                properties:
                  formatted_transcript_array:
                    type: array
                    items:
                      type: string
                    description: Array of formatted transcript segments
                  transcript:
                    type: string
                    description: Complete transcription text
                  translated_text:
                    type: string
                    nullable: true
                    description: Translated text (if translation was requested)
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          description: Processing failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /translations/openai:
    post:
      summary: Translate text using OpenAI GPT
      description: Translate text from one language to another using OpenAI's GPT models
      tags:
        - Translation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - text
              properties:
                text:
                  type: string
                  description: Text to translate
                  example: "Hello, how are you?"
                source_language:
                  type: string
                  default: "auto"
                  description: Source language code
                  example: "en"
                target_language:
                  type: string
                  default: "en"
                  description: Target language code
                  example: "es"
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - text
              properties:
                text:
                  type: string
                  description: Text to translate
                source_language:
                  type: string
                  default: "auto"
                  description: Source language code
                target_language:
                  type: string
                  default: "en"
                  description: Target language code
      responses:
        '200':
          description: Translation successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TranslationResponse'
        '400':
          description: Translation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /translations/google:
    post:
      summary: Translate text using Google Translate
      description: Translate text using Google Cloud Translation service
      tags:
        - Translation
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - text
              properties:
                text:
                  type: string
                  description: Text to translate
                  example: "Hello, how are you?"
                target_language:
                  type: string
                  default: "en"
                  description: Target language code
                  example: "es"
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - text
              properties:
                text:
                  type: string
                  description: Text to translate
                target_language:
                  type: string
                  default: "en"
                  description: Target language code
      responses:
        '200':
          description: Translation successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TranslationResponse'
        '400':
          description: Translation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /translations/deepseek:
    post:
      summary: Translate text using DeepSeek AI
      description: Medical text translation using DeepSeek with support for Asian languages and external integrations
      tags:
        - Translation
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - text
              properties:
                text:
                  type: string
                  description: Text to translate
                source_language:
                  type: string
                  default: "auto"
                  description: Source language code
                  example: "th"
                target_language:
                  type: string
                  default: "en"
                  description: Target language code
                  example: "en"
                fileName:
                  type: string
                  description: File name for external integrations
                duration:
                  type: string
                  description: Duration for external integrations
                driveId:
                  type: string
                  description: Drive ID for external integrations
                groupId:
                  type: string
                  description: Group ID for external integrations
                folderId:
                  type: string
                  description: Folder ID for external integrations
                fileId:
                  type: string
                  description: File ID for external integrations
                projectName:
                  type: string
                  description: Project name for external integrations
                isDev:
                  type: string
                  enum: ["true", "false"]
                  default: "false"
                  description: Development mode flag
                isLocal:
                  type: string
                  enum: ["true", "false"]
                  default: "false"
                  description: Local mode flag
      responses:
        '200':
          description: Translation successful
          content:
            application/json:
              schema:
                oneOf:
                  - type: object
                    properties:
                      translated_text:
                        type: string
                        description: Translated text (for local mode)
                  - type: object
                    properties:
                      message:
                        type: string
                        description: Confirmation message (for external integration)
                        example: "Request sent to external service"
        '400':
          description: Translation failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /sentiment:
    post:
      summary: Analyze sentiment of text
      description: Perform medical sentiment analysis on provided text
      tags:
        - Post-processing
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - text
              properties:
                text:
                  type: string
                  description: Text to analyze for sentiment
                  example: "The patient seems to be feeling much better today."
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - text
              properties:
                text:
                  type: string
                  description: Text to analyze for sentiment
      responses:
        '200':
          description: Sentiment analysis successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SentimentResponse'
        '400':
          description: Bad request - missing text
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /documents/word:
    post:
      summary: Generate Word document
      description: Create a DOCX document from provided text content
      tags:
        - Post-processing
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              properties:
                text:
                  type: string
                  description: Text content for the document
                  example: "This is the content of the medical transcript..."
                fileName:
                  type: string
                  default: "report.docx"
                  description: Name of the generated file
                  example: "medical_report.docx"
      responses:
        '200':
          description: Document generated successfully
          content:
            application/vnd.openxmlformats-officedocument.wordprocessingml.document:
              schema:
                type: string
                format: binary
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /reports/excel:
    post:
      summary: Generate Excel report
      description: Build an Excel workbook with multiple sheets from provided data
      tags:
        - Post-processing
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - sheets
              properties:
                sheets:
                  type: array
                  description: Array of sheet data for the Excel workbook
                  items:
                    type: object
                    properties:
                      name:
                        type: string
                        description: Sheet name
                        example: "Summary"
                      data:
                        type: array
                        description: Sheet data as array of rows
                        items:
                          type: array
                          items:
                            oneOf:
                              - type: string
                              - type: number
                        example: [["Header 1", "Header 2"], ["Value 1", "Value 2"]]
      responses:
        '200':
          description: Excel report generated successfully
          content:
            application/vnd.openxmlformats-officedocument.spreadsheetml.sheet:
              schema:
                type: string
                format: binary
        '400':
          description: Bad request - invalid payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /utilities/audio-duration:
    post:
      summary: Get audio file duration
      description: Upload an audio file to get its duration in minutes
      tags:
        - Utilities
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - audio
              properties:
                audio:
                  type: string
                  format: binary
                  description: Audio file to analyze
      responses:
        '200':
          description: Duration calculated successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Audio processed successfully"
                  duration_minutes:
                    type: number
                    format: float
                    description: Duration of the audio file in minutes
                    example: 15.5
        '400':
          description: Bad request - no audio file or analysis failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          description: Error processing audio file
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /utilities/log-usage:
    post:
      summary: Log audio usage for billing
      description: Log audio processing usage to Google Sheets for billing purposes
      tags:
        - Utilities
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - user_code
                - fileName
                - duration
              properties:
                user_code:
                  type: string
                  description: User identifier for billing
                  example: "user123"
                fileName:
                  type: string
                  description: Name of the processed file
                  example: "medical_interview.mp3"
                duration:
                  type: string
                  description: Duration in minutes
                  example: "15.5"
      responses:
        '200':
          description: Usage logged successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "File processed successfully"
                  user_code:
                    type: string
                    example: "user123"
                  filename:
                    type: string
                    example: "medical_interview.mp3"
                  duration:
                    type: number
                    format: float
                    example: 15.5
                  cost_per_minute:
                    type: string
                    example: "0.20"
                  total_cost:
                    type: string
                    example: "3.10"
                  Billed:
                    type: string
                    example: "YES"
        '400':
          description: Bad request - missing required parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '500':
          description: Error logging usage
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /utilities/text-file:
    post:
      summary: Create downloadable text file
      description: Generate a downloadable text file from provided content
      tags:
        - Utilities
      security: []
      requestBody:
        required: true
        content:
          application/x-www-form-urlencoded:
            schema:
              type: object
              required:
                - text
              properties:
                text:
                  type: string
                  description: Text content for the file
                  example: "This is the content of the text file..."
                filename:
                  type: string
                  default: "output.txt"
                  description: Desired filename (will add .txt extension if missing)
                  example: "medical_notes.txt"
      responses:
        '200':
          description: Text file generated successfully
          content:
            text/plain:
              schema:
                type: string
                format: binary
                description: Downloadable text file
        '400':
          description: Bad request - no text content provided
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Error creating text file
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: x-api-key
      description: API key required for all endpoints except health check

  schemas:
    TranscriptionResponse:
      type: object
      properties:
        text:
          type: string
          description: Transcribed text
          example: "Hello, this is a sample transcription of the audio file."
        transcript:
          type: string
          description: Alternative key for transcribed text (used by some services)
          example: "Hello, this is a sample transcription of the audio file."
        confidence:
          type: number
          format: float
          description: Confidence score of the transcription
          example: 0.95
        language:
          type: string
          description: Detected or specified language
          example: "en"
        duration:
          type: number
          format: float
          description: Duration of the audio in seconds
          example: 30.5
        chunks_processed:
          type: integer
          description: Number of chunks processed (only for large files processed with chunking)
          example: 3
        total_chunks:
          type: integer
          description: Total number of chunks created (only for large files processed with chunking)
          example: 3
        chunk_duration_minutes:
          type: integer
          description: Duration of each chunk in minutes (only for chunked processing)
          example: 10
      required:
        - transcript

      TranslationResponse:
        type: object
        properties:
          translated_text:
            type: string
            description: The translated text
            example: "El paciente presenta dolor en el pecho y niveles elevados de troponina"
          source_language:
            type: string
            description: Source language of the original text
            example: "English"
          target_language:
            type: string
            description: Target language for translation
            example: "Spanish"
          model_used:
            type: string
            description: The translation model/service used
            example: "gpt-4o-mini"
          chunks_processed:
            type: integer
            description: Number of text chunks processed (only present for long texts)
            example: 3
          total_chunks:
            type: integer
            description: Total number of chunks the text was split into (only present for long texts)
            example: 3
        required:
          - translated_text
          - source_language
          - target_language
          - model_used

      SentimentResponse:
        type: object
        properties:
        sentiment:
          type: string
          enum: ["positive", "negative", "neutral"]
          description: Overall sentiment classification
          example: "positive"
        confidence:
          type: number
          format: float
          description: Confidence score for sentiment classification
          example: 0.87
          minimum: 0
          maximum: 1
        scores:
          type: object
          description: Detailed sentiment scores
          properties:
            positive:
              type: number
              format: float
              example: 0.75
            negative:
              type: number
              format: float
              example: 0.15
            neutral:
              type: number
              format: float
              example: 0.10
        required:
          - sentiment

    ErrorResponse:
      type: object
      properties:
        error:
          type: string
          description: Error message describing what went wrong
          example: "Invalid or missing API key"
      required:
        - error

  responses:
    UnauthorizedError:
      description: Authentication information is missing or invalid
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
          example:
            error: "Invalid or missing API key"

tags:
  - name: Health
    description: Health check endpoints
  - name: Transcription
    description: Audio transcription services
  - name: Translation
    description: Text translation services
  - name: Post-processing
    description: Sentiment analysis and document generation